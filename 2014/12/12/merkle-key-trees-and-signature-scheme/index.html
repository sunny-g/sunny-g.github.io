
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Quantum Computer-Proof Digital Signatures, Part 2</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../../../../favicon.ico">

    <link rel="stylesheet" type="text/css" href="../../../../assets/css/screen.css?v=f4f3d2829c">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic%7COpen+Sans:700,400">

    <link rel="canonical" href="index.html">
    <meta name="referrer" content="origin">
    
    <meta property="og:site_name" content="Mindful Ramblings">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Quantum Computer-Proof Digital Signatures, Part 2">
    <meta property="og:description" content="In my previous post, I went over my implementation of a quantum-computer-proof digital signature algorithm known as the Lamport signature scheme. We also learned of its greatest weakness: the keypairs can only be used once. While we can't change this...">
    <meta property="og:url" content="http://localhost:2368/2014/12/12/merkle-key-trees-and-signature-scheme/">
    <meta property="article:published_time" content="2014-12-13T03:59:45.020Z">
    <meta property="article:modified_time" content="2015-04-10T01:34:58.293Z">
    <meta property="article:tag" content="lamport">
    <meta property="article:tag" content="encryption">
    <meta property="article:tag" content="signature">
    <meta property="article:tag" content="digital signature">
    <meta property="article:tag" content="merkle">
    <meta property="article:tag" content="quantum computer">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Quantum Computer-Proof Digital Signatures, Part 2">
    <meta name="twitter:description" content="In my previous post, I went over my implementation of a quantum-computer-proof digital signature algorithm known as the Lamport signature scheme. We also learned of its greatest weakness: the keypairs can only be used once. While we can't change this...">
    <meta name="twitter:url" content="http://localhost:2368/2014/12/12/merkle-key-trees-and-signature-scheme/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Mindful Ramblings",
    "author": {
        "@type": "Person",
        "name": "Sunny G",
        "image": "//www.gravatar.com/avatar/1700de0def81fad9d8987101ee6704d6?s=250&d=mm&r=x",
        "url": "http://localhost:2368/author/sunny",
        "sameAs": "http://blog.sunnyg.io",
        "description": null
    },
    "headline": "Quantum Computer-Proof Digital Signatures, Part 2",
    "url": "http://localhost:2368/2014/12/12/merkle-key-trees-and-signature-scheme/",
    "datePublished": "2014-12-13T03:59:45.020Z",
    "dateModified": "2015-04-10T01:34:58.293Z",
    "keywords": "lamport, encryption, signature, digital signature, merkle, quantum computer",
    "description": "In my previous post, I went over my implementation of a quantum-computer-proof digital signature algorithm known as the Lamport signature scheme. We also learned of its greatest weakness: the keypairs can only be used once. While we can&#x27;t change this..."
}
    </script>

    <meta name="generator" content="Ghost 0.7">
    <link rel="alternate" type="application/rss+xml" title="Mindful Ramblings" href="../../../../rss/index.html">
    <script type="application/ld+json">
{
   	"@context": "http://schema.org",
	"sample": "data"
}
</script>
</head>
<body class="post-template tag-lamport tag-encryption tag-signature tag-digital-signature tag-merkle tag-quantum-computer nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="index.html#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
            <li class="nav-home" role="presentation"><a href="../../../../">Home</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="../../../../rss/index.rss">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
            <a class="menu-button icon-menu" href="index.html#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-lamport tag-encryption tag-signature tag-digital-signature tag-merkle tag-quantum-computer">

        <header class="post-header">
            <h1 class="post-title">Quantum Computer-Proof Digital Signatures, Part 2</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2014-12-12">12 December 2014</time>  on <a href="../../../../tag/lamport/">lamport</a>, <a href="../../../../tag/encryption/">encryption</a>, <a href="../../../../tag/signature/">signature</a>, <a href="../../../../tag/digital-signature/">digital signature</a>, <a href="../../../../tag/merkle/">merkle</a>, <a href="../../../../tag/quantum-computer/">quantum computer</a>
            </section>
        </header>

        <section class="post-content">
            <p>In my previous <a href="http://blog.sunnyg.io/2014/12/07/lamport-key-pairs-and-signature-scheme/">post</a>, I went over my <a href="https://github.com/sunny-g/lamport-merkle.js">implementation</a> of a quantum-computer-proof digital signature algorithm known as the <a href="https://en.wikipedia.org/wiki/Lamport_signature">Lamport signature scheme</a>. We also learned of its greatest weakness: the keypairs can only be used once. While we can't change this property of the algorithm, we can mitigate the weakness by chaining multiple Lamport keys together into a <a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree</a>.</p>

<h3 id="keypairstructure">Keypair Structure</h3>

<p>A Merkle tree is just a <a href="https://en.wikipedia.org/wiki/Tree_%28data_structure%29">tree</a> where each node's value is the hash of its children's values. The top (or root) node has the interesting property of implicitly containing the information of the entire tree since every node's value implicitly contains the values of if it's children.</p>

<p>So with this in mind, we will start by generating a Lamport keypair for every message we may want to sign with this key tree (the variable <code>keyNum</code>). We then generate the hash of each keypair's public key and store these hashes in our tree (along with the keypairs and other useful information like the <code>size</code>, <code>numOfLevels</code> in the tree, and the <code>topHash</code>, which is effectively our key tree's public key). </p>

<pre><code>var MerkleKeyTree = function(keyNum) {
  this.size = keyNum || KEYNUM;
  this._leaves = [];
  this.usedKeyCount = 0;
  var firstRow = [];
  for (var leafNum = 0; leafNum &lt; this.size; leafNum++) {
    var keypair = new LamportKeypair();
    this._leaves.push(keypair);
    firstRow.push( hash(keypair.pubKey) );
  }
  this.levels = [firstRow];

  var levels = Math.ceil(Math.log2(this.size));
  for (var i = 1; i &lt;= levels; i++) {
    // for each level in the tree starting w/ 1 above the bottom
    var curRow = [];
    var prevRow = this.levels[i-1];
    for (var k = 0; k &lt; prevRow.length; k += 2) {
      // for each hash in the previous row
      // hash it and the next hash's values
      var h = hash(prevRow[k] + prevRow[k+1]);
      curRow.push(h);
    }
    this.levels[i] = curRow;
  }

  this.numOfLevels = this.levels.length;
  this.numOfKeys = this._leaves.length;
  this.topHash = this.levels[this.levels.length - 1][0];
};
</code></pre>

<p>So here's what the Merkle tree in our key tree looks like, with each array containing the hashes of its two child hashes:</p>

<p><img src="../../../../content/images/2014/12/Screen-Shot-2014-12-12-at-7-36-15-PM-1.png" alt="A sample Merkle key tree"></p>

<h3 id="messagesigning">Message Signing</h3>

<p>To use this tree to sign a message, we have to: </p>

<ol>
<li>Select a keypair (<code>leaf</code>) and use it to generate a signature.  </li>
<li>Publish the signature, along with the path of hashes at each level necessary to recreate the <code>topHash</code></li>
</ol>

<p>We <em>must</em> publish the path so that once the user verifies that the Lamport keypair we used was legitimate, they can hash the public key + sibling public key, and continue hashing these hashes + their siblings until they reach the <code>topHash</code>.</p>

<pre><code>    MerkleKeyTree.prototype.sign = function(msg) {
      var finalSig = {};
      if (this.usedKeyCount === this.size - 1) {
        throw new Error('This is your last keypair on this tree);
      }
      // select the first unused keypair
      for (var i = 0; i &lt; this.numOfKeys; i++) {
        if (!this._leaves[i].used) {
          var randomKeypair = this._leaves[i];
          var randomKeypairIndex = i;
          break;
        }
      }
      finalSig.keyPairId = randomKeypairIndex;
      finalSig.pubKey = randomKeypair.pubKey;
      finalSig.message = msg;
      finalSig.signature = randomKeypair.sign(msg);
      // create the path of the hashes needed to get from the
        // published keypair to the topHash
      finalSig.path = [];
      var curLevel = 0;
      var idx = randomKeypairIndex;
      while (curLevel &lt; this.numOfLevels) {
        if (idx % 2) {
          finalSig.path.push(this.levels[curLevel][idx - 1])
        } else {
          finalSig.path.push(this.levels[curLevel][idx + 1])
        }
        curLevel++;
        idx = parentIdx(idx);
      }
      // publish the signature, set key properties
      finalSig.path[finalSig.path.length - 1] = this.topHash;
      randomKeypair.used = true;
      this.usedKeyCount++;
      return finalSig;
    };
</code></pre>

<p>Here's an example signature of a message signed by the key tree above: <br>
<img src="../../../../content/images/2014/12/Screen-Shot-2014-12-12-at-7-39-34-PM-1.png" alt="A sample signature"></p>

<h3 id="messageverification">Message Verification</h3>

<p>To verify a signature, we must first verify <code>signature</code> against <code>pubKey</code>, just as we would with a traditional Lamport key. Then, we'll have to hash the <code>pubKey</code> and hash the result (in the right order) with its sibling key's hash, and keep taking the output and hashing it with its sibling in the next level of the key tree until we end up with one, lone hash. </p>

<pre><code>MerkleKeyTree.prototype.verify = function(sigObj) {
  var idx = sigObj.keyPairId;
  var lamport = this._leaves[idx];
  // if this is a valid Lamport signature...
  if (lamport.verify(sigObj.message, sigObj.signature)) {

    // ... calculate the sibling hashes until you reach the topHash  
    var h = hash(sigObj.pubKey);
    for (var i = 0; i &lt; sigObj.path.length - 1; i++) {
      var auth = sigObj.path[i];
      if (idx % 2) {
        h = hash(auth + h);
      } else {
        h = hash(h + auth);
      }
      idx = parentIdx(idx); // gets the parent level hash index
    }
    if (h === sigObj.path[sigObj.path.length - 1]) { return true; }
  }
  return false;
};
</code></pre>

<p>If at the end of this process we end up with the string at the end of our <code>path</code> array (which is also our <code>topHash</code>), we'll know that the key used to sign the message belongs to this key tree and this <code>topHash</code> (which should match up with the <code>topHash</code> of the expected owner and message signer). </p>

<p>In conclusion, with this signature scheme, we've allowed a user to generate one large key tree that can be used to sign arbitrarily many messages (including newer keytrees) while only marginally increasing the signature size. While this can't be used for secretly encrypting messages, in many applications (e.g. authenticating cryptocurrency transactions), a signature scheme is just enough. </p>

<p>I hope both of these posts have shed some light on how wild yet understandable some cryptographic concepts can be. You can always check out my repo <a href="https://github.com/sunny-g/lamport-merkle.js">here</a> and as always, thanks for reading!</p>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="../../../../author/sunny/" style="background-image: url(http://www.gravatar.com/avatar/1700de0def81fad9d8987101ee6704d6?s=250&amp;d=mm&amp;r=x)"><span class="hidden">Sunny G's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="../../../../author/sunny/">Sunny G</a></h4>

                    <p>Read <a href="../../../../author/sunny/">more posts</a> by this author.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">San Francisco</span>
                    <span class="author-link icon-link"><a href="http://blog.sunnyg.io">http://blog.sunnyg.io</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Quantum%20Computer-Proof%20Digital%20Signatures%2C%20Part%202&amp;url=http://localhost:2368/2014/12/12/merkle-key-trees-and-signature-scheme/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/2014/12/12/merkle-key-trees-and-signature-scheme/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/2014/12/12/merkle-key-trees-and-signature-scheme/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>

    </article>
</main>

<aside class="read-next">
    <a class="read-next-story no-cover" href="../../18/introduction-to-auth0/">
        <section class="post">
            <h2>Introduction to Auth0</h2>
            <p>One major component of our thesis project is the ability to authenticate users from their Facebook accounts and vendors…</p>
        </section>
    </a>
    <a class="read-next-story prev no-cover" href="../../07/lamport-key-pairs-and-signature-scheme/">
        <section class="post">
            <h2>Quantum Computer-Proof Digital Signatures, Part 1</h2>
            <p>For my MVP (minimal viable product) project at Hack Reactor, I developed a browser library that implements two quantum-computer-proof…</p>
        </section>
    </a>
</aside>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'sunnygblog';
    var disqus_identifier = '';
 
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> 



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="../../../../">Mindful Ramblings</a> © 2015</section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
        </footer>

    </div>

    <script type="application/ld+json">
{
   	"@context": "http://schema.org",
	"sample": "footer"
}
</script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="../../../../assets/js/jquery.fitvids.js?v=f4f3d2829c"></script>
    <script type="text/javascript" src="../../../../assets/js/index.js?v=f4f3d2829c"></script>

</body>
